<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emushi Gacha Tool - FX Edition</title>
<style>
  :root{
    --bg:#0b1020; --card:#0f1630cc; --accent:#5aa1ff; --accent2:#8bd5ff;
    --gold:#d9b061; --text:#ecf3ff; --muted:#99a4c2; --danger:#ff6b7a; --ok:#50e3a4;
    --glass: blur(8px) saturate(120%);
    --p-accent:#ffb366; --p-accent2:#ff884f;
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--text); background:var(--bg);
    font-family: ui-sans-serif,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    overflow-x:hidden;
  }

  /* 背景：最初は非表示 → オープニング後にふわっと表示 */
  .bg-img{
    position:fixed; inset:0; pointer-events:none; z-index:-2;
    background:
      radial-gradient(1200px 600px at 90% -10%, #5aa1ff22, transparent 60%),
      radial-gradient(800px 800px at 10% 110%, #8bd5ff22, transparent 60%),
      url("image/emushi_mainvisual_00.png") center/cover no-repeat;
    filter:saturate(110%) contrast(105%) brightness(90%);
    opacity:0;                     /* ← ここを0からスタート */
    transform:scale(1.03);
  }
  .bg-img.bg-show{
    animation:bgIn .8s ease forwards;
  }
  @keyframes bgIn{
    0%{opacity:0; transform:scale(1.03);}
    100%{opacity:.22; transform:scale(1);}
  }

  #starfield{position:fixed; inset:0; z-index:-1; pointer-events:none;}

  .wrap{max-width:1100px; margin:28px auto; padding:0 16px; position:relative;}
  .title{display:flex; align-items:center; gap:12px; margin:0 0 8px 0; font-weight:800; letter-spacing:.3px}
  .badge{padding:4px 10px; border:1px solid #ffffff22; border-radius:999px; font-size:12px; color:var(--gold); background:#171d35aa; box-shadow:0 0 0 1px #000 inset}
  .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between}
  .sound-toggle{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px;
    background:#101737; border:1px solid #2b396d; color:#cfe3ff; cursor:pointer; user-select:none; font-weight:700;
  }
  .sound-toggle[data-on="true"]{background:linear-gradient(180deg,#23306d,#1a2760); box-shadow:0 0 0 1px #3b57b8 inset}

  .tabs-bar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin:14px 0;}
  .tabs{display:flex; gap:8px; flex-wrap:wrap;}
  .tab-btn{appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:12px;
    color:#cfe3ff; background:#101737; border:1px solid #ffffff22; font-weight:700; transition:.2s transform,.2s box-shadow,.2s background;}
  .tab-btn.active{background:linear-gradient(180deg,#23306d,#1a2760); box-shadow:0 0 0 1px #3b57b8 inset, 0 8px 24px #24399666}

  .mode-switch{display:inline-flex; background:#101737; border:1px solid #2b396d; border-radius:999px; overflow:hidden;}
  .mode-btn{padding:6px 12px; border:none; background:transparent; color:#cfe3ff; font-weight:700; cursor:pointer;}
  .mode-btn.active{background:linear-gradient(180deg,#23306d,#1a2760); }

  .panic-btn{
    background:linear-gradient(180deg,#ffba8a,#ff6b6b);
    border:none; border-radius:999px; padding:10px 14px; color:#180d1a; font-weight:800; cursor:pointer;
    box-shadow:0 4px 14px #ff6b6b55; position:relative; overflow:hidden;
  }
  .panic-btn.warp::after{
    content:"";
    position:absolute; inset:-10px;
    background:radial-gradient(circle,#ffffff33 0%,transparent 70%);
    animation:timeWarp .5s ease;
    pointer-events:none;
  }
  @keyframes timeWarp{
    0%{transform:scale(0); opacity:1;}
    40%{transform:scale(1.1); opacity:.9;}
    100%{transform:scale(1.7); opacity:0;}
  }
  .panic-btn.reset-anim{
    animation:resetPulse .55s ease;
  }
  @keyframes resetPulse{
    0%{transform:rotate(0deg) scale(1);}
    25%{transform:rotate(-8deg) scale(1.05);}
    55%{transform:rotate(12deg) scale(1.02);}
    100%{transform:rotate(0deg) scale(1);}
  }

  .card{
    background: linear-gradient(180deg,#121a37aa,#0e1531cc); backdrop-filter:var(--glass);
    border:1px solid #ffffff22; border-radius:18px; box-shadow:0 20px 60px #0008, inset 0 1px #ffffff11; position:relative;
    transform-origin:center center;
  }
  body.mode-participants .card{border-color:rgba(255,179,102,.4);}
  body.mode-participants #tab-draw{box-shadow:0 0 0 1px rgba(255,179,102,.2), 0 18px 50px #000a;}

  /* タブがどこでもflipするやつ */
  .card.mode-flip{
    animation:modeFlip .55s ease;
    transform-style:preserve-3d;
  }
  @keyframes modeFlip{
    0%{transform:perspective(900px) rotateY(0deg); opacity:1;}
    48%{transform:perspective(900px) rotateY(75deg); opacity:.15;}
    52%{transform:perspective(900px) rotateY(-75deg); opacity:.15;}
    100%{transform:perspective(900px) rotateY(0deg); opacity:1;}
  }

  .grid{display:grid; gap:16px}
  @media(min-width:900px){ .grid-2{grid-template-columns:1.1fr .9fr} }
  .section{padding:18px; opacity:0; transform:translateY(14px);
    transition: opacity .45s ease, transform .45s ease;}
  .section.active{opacity:1; transform:translateY(0)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .field{display:flex; flex-direction:column; gap:6px; min-width:160px; flex:1}
  .field label{font-size:12px; color:var(--muted)}
  input[type="text"],input[type="number"],textarea,select{
    width:100%; box-sizing:border-box; background:#0c1332; color:#ecf3ff;
    border:1px solid #2b396d; border-radius:12px; padding:12px 12px; outline:none; transition:.15s border,.15s box-shadow;}
  input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{appearance:none;margin:0}
  input:focus,textarea:focus,select:focus{border-color:#5aa1ff; box-shadow:0 0 0 3px #5aa1ff22}
  .btn{appearance:none; border:none; border-radius:12px; padding:12px 14px; cursor:pointer; color:#0c122a; font-weight:800;
       background:linear-gradient(180deg,#79b1ff,#4d7eff); box-shadow:0 8px 20px #2444ff66, inset 0 1px #ffffffaa; transition:.15s transform,.2s filter;}
  .btn:hover{filter:brightness(1.06)} .btn:active{transform:translateY(1px)}
  .btn-ghost{color:#d7e6ff; background:#101737; border:1px solid #2b396d; box-shadow:none; font-weight:700;}
  .btn-danger{ background:linear-gradient(180deg,#ff8aa0,#ff5a73); box-shadow:0 8px 20px #ff2e6955}
  .btn-ok{ background:linear-gradient(180deg,#7de1b6,#46c98f); box-shadow:0 8px 20px #2bd68d55}
  .small{font-size:12px; color:var(--muted)}
  .pill{padding:6px 10px; border-radius:999px; background:#10183b; border:1px solid #2a3a73; color:#cfe3ff; font-size:12px}
  .log{flex:1 1 auto; min-height:220px; max-height:420px; overflow:auto; background:#0b1231; border:1px solid #22316a; border-radius:12px; padding:10px}
  .divider{height:1px; background:linear-gradient(90deg,transparent,#3b4d8e,transparent); margin:12px 0}
  .subcard{border:1px solid #2a3a73; border-radius:14px; padding:12px; background:#0f1536; box-shadow: inset 0 1px #ffffff10;}

  .sec-title{margin:0 0 6px 0; font-size:14px; letter-spacing:.05em;}
  .title-row{display:flex; gap:8px; align-items:center; justify-content:space-between;}
  .copy-btn{background:#0e1430; border:1px solid #5aa1ff66; color:#e3f0ff; border-radius:999px; padding:4px 10px; font-size:11px; cursor:pointer;}
  .copy-btn:active{transform:translateY(1px);}

  .result{background:#0b1231; border:1px solid #22316a; border-radius:14px; padding:10px}
  .result-current{
    min-height:190px;
    background:radial-gradient(circle at top, rgba(90,161,255,.14), #0b1231 52%);
    border:1px solid rgba(138,191,255,.4);
    box-shadow:inset 0 1px rgba(255,255,255,.03);
    font-size:14px;
  }
  .result-total{
    min-height:135px;
    background:#0b1231;
    border:1px solid #182046;
    opacity:.95;
  }
  .pulse-glow{animation:pulseGlow .8s ease;}
  @keyframes pulseGlow{
    0%{box-shadow:0 0 0 0 rgba(130,180,255,.45);}
    100%{box-shadow:0 0 0 14px rgba(130,180,255,0);}
  }

  .step-row{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;}
  .step-btn{min-width:58px; text-align:center; background:#0d1330; border:1px solid #2a3a73; color:#dbe6ff; border-radius:10px; padding:6px 6px; font-weight:700; cursor:pointer;}
  .step-btn:active{transform:translateY(1px);}

  /* 商品一覧 */
  .tr{
    display:grid;
    grid-template-columns:82px minmax(120px,1fr) 100px 160px 80px;
    gap:8px; align-items:center; padding:8px 10px; margin-bottom:8px;
    background:#0f1536; border:1px solid #25326a; border-radius:12px; position:relative
  }
  .handle-wrap{display:flex; flex-direction:column; gap:4px; align-items:flex-start; justify-content:flex-start;}
  .handle{cursor:grab; color:#7f9ad9; text-align:left; line-height:1;}
  .move-row{display:flex; gap:4px;}
  .btn-move-small{background:#1a2450; border:1px solid #2b396d; color:#d7e6ff; border-radius:6px; padding:2px 6px; font-size:11px; cursor:pointer;}
  .btn-move-small:active{transform:translateY(1px);}
  .rarity{font-weight:800; color:#9dc6ff; display:block; line-height:1.2;}
  .name-small{font-size:11px; color:rgba(236,243,255,.7); word-break:break-all;}
  .tr.added{animation:addPop .36s ease}
  @keyframes addPop{0%{transform:scale(.92); box-shadow:0 0 0 2px #5aa1ff66 inset; background:#5aa1ff22}
                    100%{transform:scale(1); box-shadow:none; background:#0f1536}}
  .tr.reorder-anim{animation:reorder .25s ease;}
  @keyframes reorder{from{transform:translateY(-6px); opacity:.6}to{transform:translateY(0); opacity:1}}

  /* 参加者タブ類（上に細く） */
  #p-topbar{
    display:none;
    gap:10px;
    margin-bottom:8px;
    background:rgba(10,14,30,.35);
    border:1px solid rgba(255,179,102,.35);
    border-radius:12px;
    padding:10px 12px;
    align-items:center;
  }
  body.mode-participants #p-topbar{display:flex;}
  #participant-tabs-wrap{display:none; margin-bottom:10px;}
  body.mode-participants #participant-tabs-wrap{display:block;}
  .p-tab-bar{display:flex; flex-wrap:wrap; gap:6px;}
  .p-tab{
    background:#1a2754; border:1px solid rgba(255,255,255,.04); border-radius:999px;
    padding:5px 12px; cursor:pointer; display:flex; gap:6px; align-items:center; color:#fff;
    transition:.2s transform,.2s background; white-space:nowrap;
  }
  .p-tab.active{
    background:linear-gradient(180deg,#ffb366,#ff884f); color:#1b0f0b;
    transform:translateY(-2px);
  }
  .p-tab.switching{animation:pTab .25s ease;}
  @keyframes pTab{from{transform:translateY(4px); opacity:.5}to{transform:translateY(0); opacity:1}}

  /* JSON */
  .json-flow{display:flex; gap:14px; flex-wrap:wrap;}
  .json-step{flex:1 1 260px; background:#0f1536; border:1px solid #2a3a73; border-radius:12px; padding:10px;}
  .json-step h4{margin:0 0 6px 0; font-size:13px;}
  .json-step p{margin:0 0 6px 0; font-size:12px; color:var(--muted);}

  /* トースト */
  #toast{
    position:fixed; bottom:18px; left:50%; transform:translate(-50%,20px);
    background:#18285a; color:#cfe3ff; padding:8px 16px; border-radius:12px;
    opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:100;
  }
  #toast.show{opacity:1; transform:translate(-50%,0);}

  body.mode-transition .wrap{animation:modeFade .45s ease;}
  @keyframes modeFade{from{opacity:.4; transform:translateY(6px);}to{opacity:1; transform:translateY(0);}}

  /* ======== 新オープニング（全画面） ======== */
  #intro-screen{
    position:fixed; inset:0; z-index:999;
    background:radial-gradient(circle at center, rgba(2,3,12,.25) 0%, rgba(0,0,0,1) 80%), url("image/emushi_mainvisual_00.png") center/cover no-repeat;
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  #intro-overlay{
    position:absolute; inset:0;
    background:radial-gradient(circle at center, rgba(2,7,20,.3), rgba(2,3,7,.9));
    pointer-events:none;
  }
  .intro-title{
    position:relative; z-index:2;
    font-size:clamp(2.7rem, 4.5vw, 4.4rem);
    text-align:center; line-height:1.02;
    font-weight:900; letter-spacing:.06em;
    color:#f7fbff;
    text-shadow:0 0 20px rgba(81,149,255,.9), 0 0 60px rgba(20,42,75,.9);
    filter:drop-shadow(0 14px 40px rgba(0,0,0,.4));
    transform:scale(.85) translateY(24px);
    opacity:0;
    animation:introTitleZoom .95s ease-out .1s forwards;
  }
  @keyframes introTitleZoom{
    0%{opacity:0; transform:scale(.85) translateY(24px);}
    50%{opacity:1; transform:scale(1.04) translateY(0);}
    100%{opacity:1; transform:scale(1) translateY(0);}
  }
  .intro-sweep{
    position:absolute; inset:-10% -50%; height:160%; background:linear-gradient(90deg,transparent,rgba(255,255,255,.55),transparent);
    transform:skewX(-22deg) translateX(-80%);
    filter:blur(1.2px);
    animation:introSweep 1.4s ease .35s forwards;
  }
  @keyframes introSweep{
    0%{transform:skewX(-22deg) translateX(-80%); opacity:0;}
    10%{opacity:1;}
    100%{transform:skewX(-22deg) translateX(60%); opacity:0;}
  }
  #intro-screen.hide{
    animation:introOut .4s ease forwards;
  }
  @keyframes introOut{
    from{opacity:1; transform:scale(1);}
    to{opacity:0; transform:scale(1.02); visibility:hidden;}
  }
</style>
</head>
<body>
<canvas id="starfield"></canvas>
<div class="bg-img" aria-hidden="true"></div>

<!-- オープニング：全画面 -->
<div id="intro-screen">
  <div id="intro-overlay"></div>
  <div class="intro-title">Emushi MultiGacha Studio</div>
  <div class="intro-sweep"></div>
</div>

<div class="wrap">
  <div class="toolbar">
    <h1 class="title">Emushi Gacha Tool <span class="badge">FX + JSON Profiles</span></h1>
    <div style="display:flex;gap:10px;align-items:center;">
      <div class="mode-switch" id="modeSwitch">
        <button class="mode-btn active" data-mode="normal">通常</button>
        <button class="mode-btn" data-mode="participants">参加者</button>
      </div>
      <div id="soundToggle" class="sound-toggle" role="button" aria-pressed="true" data-on="true">
        🔊 サウンド：<span id="soundLabel">ON</span>
      </div>
    </div>
  </div>

  <div class="tabs-bar">
    <div class="tabs">
      <button class="tab-btn active" data-tab="draw">抽選</button>
      <button class="tab-btn" data-tab="settings">設定</button>
      <button class="tab-btn" data-tab="storage">プロファイル</button>
    </div>
    <button id="btn-undo-global" class="panic-btn">ミスった！いっかい戻す！</button>
  </div>

  <!-- 抽選 -->
  <div id="tab-draw" class="card section active">
    <!-- 参加者用トップバー -->
    <div id="p-topbar">
      <input id="p-new-name" type="text" placeholder="参加者名" style="flex:1 1 160px;">
      <button class="btn btn-ok" id="p-new-add" style="flex:0 0 auto;">追加</button>
      <button class="btn btn-danger" id="p-btn-delete" style="flex:0 0 auto;">選択中の参加者を削除</button>
      <span class="small">※最大50人まで</span>
    </div>

    <!-- 参加者タブ -->
    <div id="participant-tabs-wrap">
      <div class="p-tab-bar" id="p-tab-bar"></div>
    </div>

    <!-- 通常モード -->
    <div id="draw-normal" class="grid grid-2">
      <div>
        <h3 class="sec-title">シングル抽選</h3>
        <div class="subcard" style="margin-bottom:12px">
          <button class="btn" id="btn-once">1回抽選</button>
        </div>

        <h3 class="sec-title">回数指定で抽選</h3>
        <div class="subcard">
          <div class="row" style="gap:8px;align-items:center;margin-bottom:4px;">
            <input id="in-times" type="number" min="1" value="10" style="width:120px">
            <button class="btn btn-ok" id="btn-batch">回数指定で抽選</button>
          </div>
          <div class="step-row">
            <button class="step-btn" data-step="-1000">-1000</button>
            <button class="step-btn" data-step="-100">-100</button>
            <button class="step-btn" data-step="-10">-10</button>
            <button class="step-btn" data-step="-1">-1</button>
            <button class="step-btn" data-step="reset">0</button>
            <button class="step-btn" data-step="1">+1</button>
            <button class="step-btn" data-step="10">+10</button>
            <button class="step-btn" data-step="100">+100</button>
            <button class="step-btn" data-step="1000">+1000</button>
          </div>
        </div>

        <div class="divider"></div>
        <div class="title-row">
          <h3 style="margin:0">今回の結果</h3>
          <button class="copy-btn" id="btn-copy-current">コピー</button>
        </div>
        <div id="result" class="result result-current"></div>
        <div class="title-row" style="margin-top:14px;">
          <h3 style="margin:0">累計結果</h3>
          <button class="copy-btn" id="btn-copy-total">コピー</button>
        </div>
        <div id="total" class="result result-total"></div>
        <div class="row" style="gap:8px;margin-top:6px">
          <button class="btn btn-ghost" id="btn-total-reset">累計リセット</button>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <h3 style="margin-bottom:4px;">ログ</h3>
        <div id="log" class="log"></div>
      </div>
    </div>

    <!-- 参加者モード -->
    <div id="draw-participants" style="display:none;">
      <div class="grid grid-2" style="gap:14px;">
        <div>
          <h3 class="sec-title">シングル抽選</h3>
          <div class="subcard" style="margin-bottom:12px">
            <button class="btn" id="p-btn-once">1回抽選</button>
          </div>
          <h3 class="sec-title">回数指定で抽選</h3>
          <div class="subcard">
            <div class="row" style="gap:8px;align-items:center;margin-bottom:4px;">
              <input id="p-in-times" type="number" min="1" value="10" style="width:120px">
              <button class="btn btn-ok" id="p-btn-batch">回数指定で抽選</button>
            </div>
            <div class="step-row">
              <button class="step-btn" data-pstep="-1000">-1000</button>
              <button class="step-btn" data-pstep="-100">-100</button>
              <button class="step-btn" data-pstep="-10">-10</button>
              <button class="step-btn" data-pstep="-1">-1</button>
              <button class="step-btn" data-pstep="reset">0</button>
              <button class="step-btn" data-pstep="1">+1</button>
              <button class="step-btn" data-pstep="10">+10</button>
              <button class="step-btn" data-pstep="100">+100</button>
              <button class="step-btn" data-pstep="1000">+1000</button>
            </div>
          </div>

          <div class="divider"></div>
          <div class="title-row">
            <h3 style="margin:0">今回の結果</h3>
            <button class="copy-btn" id="p-btn-copy-current">コピー</button>
          </div>
          <div id="p-result" class="result result-current"></div>
          <div class="title-row" style="margin-top:14px;">
            <h3 style="margin:0">累計結果</h3>
            <button class="copy-btn" id="p-btn-copy-total">コピー</button>
          </div>
          <div id="p-total" class="result result-total"></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div id="p-overall"></div>
          <h3 style="margin-bottom:4px;">ログ</h3>
          <div id="p-log" class="log"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 設定 -->
  <div id="tab-settings" class="card section grid grid-2" style="display:none">
    <div>
      <h3>商品を追加</h3>
      <div class="row">
        <div class="field"><label>レア度（自由入力）</label><input id="in-rarity" type="text" placeholder="UR / SSR / SR / R / N"></div>
        <div class="field"><label>商品名</label><input id="in-name" type="text" placeholder="直筆サイン色紙"></div>
        <div class="field"><label>確率（%）</label><input id="in-prob" type="number" min="0" step="0.0001" placeholder="0.3333"></div>
      </div>
      <div class="row" style="gap:8px;margin-top:8px">
        <button class="btn" id="btn-add">商品追加</button>
        <button class="btn btn-ghost" id="btn-clear">一覧クリア</button>
      </div>
      <div class="divider"></div>

      <div class="row" style="gap:8px; margin-bottom:8px;">
        <span class="pill">合計確率: <span id="kpi-total">0%</span></span>
        <span class="pill">ハズレ: <span id="kpi-miss">100%</span></span>
        <span class="pill">アイテム数: <span id="kpi-count">0</span></span>
      </div>

      <h3>商品一覧 <span id="sum-prob" class="small"></span></h3>
      <div id="list"></div>
      <div class="small" id="warn-over"></div>
    </div>
    <div></div>
  </div>

  <!-- プロファイル -->
  <div id="tab-storage" class="card section" style="display:none">
    <h3>プロファイル / JSON入出力</h3>
    <div class="row">
      <div class="field" style="max-width:320px"><label>プロファイル名</label><input id="profile-name" type="text" placeholder="闇ガチャ_配信"></div>
      <div class="field" style="max-width:320px"><label>保存済みプロファイル</label><select id="profile-list"></select></div>
    </div>
    <div class="row" style="gap:8px;margin-top:8px">
      <button class="btn" id="btn-profile-save">この設定を保存</button>
      <button class="btn btn-ghost" id="btn-profile-load">読み込み</button>
      <button class="btn btn-ghost" id="btn-profile-rename">名前変更</button>
      <button class="btn btn-danger" id="btn-profile-delete">削除</button>
    </div>
    <p class="small">保存先はブラウザの <b>localStorage</b>。同じ端末/ブラウザで使ってください。</p>

    <div class="divider"></div>
    <h3>JSON入出力</h3>
    <div class="json-flow">
      <div class="json-step">
        <h4>① 今の設定を書き出す</h4>
        <p>押すと下にJSONが出るのでコピーしておけます。</p>
        <button class="btn btn-ghost" id="btn-export">設定を書き出し</button>
        <button class="btn btn-ghost" id="btn-json-copy">↑ 書き出したのをコピー</button>
      </div>
      <div class="json-step">
        <h4>② 保存してあるJSONを読み込む</h4>
        <p>下にペーストしてから「設定を読み込み」。</p>
        <button class="btn btn-ghost" id="btn-json-paste">↓ ペースト</button>
        <button class="btn btn-ghost" id="btn-import">設定を読み込み</button>
      </div>
    </div>
    <textarea id="json-area" rows="8" placeholder='[{"rarity":"SSR","name":"景品A","prob":1.5}]' style="margin-top:10px"></textarea>
  </div>
</div>

<div id="toast">コピーしました</div>
<audio id="sfx-draw" src="sfx_draw.mp3" preload="auto"></audio>

<script>
const state = {
  mode: "normal",
  items: [],
  totals: {},
  history: [],
  participants: [],
  selectedParticipantId: null,
  overallParticipantTotals: {},
  lastSession: null,
  profileKey: "emushi_gacha_profiles_v1",
  soundKey: "emushi_gacha_sound_on",
  soundOn: true,
};

const $ = q=>document.querySelector(q);
const listEl=$("#list"), sumEl=$("#sum-prob"), warnEl=$("#warn-over");
const kpiTotal=$("#kpi-total"), kpiMiss=$("#kpi-miss"), kpiCount=$("#kpi-count");

function showToast(msg="コピーしました"){
  const t=$("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1400);
}

/* ===== 新オープニング：2.8sで閉じる・タップでも閉じる ===== */
window.addEventListener("load", ()=>{
  const intro=$("#intro-screen");
  const bg = document.querySelector(".bg-img");
  const hide=()=>{
    if(!intro.classList.contains("hide")){
      intro.classList.add("hide");
      // オープニングが終わったら背景をふわっと出す
      if(bg){ setTimeout(()=> bg.classList.add("bg-show"), 120); }
      setTimeout(()=>{ intro.style.display="none"; }, 420);
    }
  };
  setTimeout(hide, 2800);
  intro.addEventListener("click", hide, {once:true});
});

/* サウンド */
const soundToggle = $("#soundToggle");
const soundLabel = $("#soundLabel");
initSound();
soundToggle.addEventListener("click", ()=>{ state.soundOn=!state.soundOn; localStorage.setItem(state.soundKey, state.soundOn?"1":"0"); applySoundUI(); });
function initSound(){
  const saved = localStorage.getItem(state.soundKey);
  state.soundOn = saved===null ? true : saved==="1";
  applySoundUI();
}
function applySoundUI(){
  soundToggle.dataset.on = state.soundOn ? "true":"false";
  soundLabel.textContent = state.soundOn ? "ON" : "OFF";
}
function playSE(id){
  if(!state.soundOn) return;
  const a = document.getElementById(id);
  if(a){ try{ a.currentTime=0; a.play().catch(()=>{}); }catch{} }
}

/* タブ */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const key = btn.dataset.tab;
    ["settings","draw","storage"].forEach(t=>{
      const el = $("#tab-"+t);
      const show = (t===key);
      el.style.display = show ? "" : "none";
      requestAnimationFrame(()=>{ el.classList.toggle("active", show); });
    });
  });
});

/* モード切替：ここを全カードflipに修正済み */
document.querySelectorAll("#modeSwitch .mode-btn").forEach(b=>{
  b.addEventListener("click", ()=>{
    const m = b.dataset.mode;
    if(state.mode===m) return;
    state.mode = m;

    // 全カードにめくりをかける
    const cards = document.querySelectorAll(".card");
    cards.forEach(card=>{
      card.classList.add("mode-flip");
      setTimeout(()=>card.classList.remove("mode-flip"), 560);
    });

    document.body.classList.add("mode-transition");
    setTimeout(()=>document.body.classList.remove("mode-transition"),500);

    document.body.classList.toggle("mode-participants", m==="participants");
    document.querySelectorAll("#modeSwitch .mode-btn").forEach(bb=>bb.classList.toggle("active", bb.dataset.mode===m));

    if(m==="normal"){
      $("#draw-normal").style.display="";
      $("#draw-participants").style.display="none";
      $("#participant-tabs-wrap").style.display="none";
      $("#p-topbar").style.display="none";
    }else{
      $("#draw-normal").style.display="none";
      $("#draw-participants").style.display="";
      $("#participant-tabs-wrap").style.display="block";
      $("#p-topbar").style.display="flex";
      renderParticipantTabs();
      renderParticipantView();
      renderParticipantOverall();
    }
  });
});

/* 商品追加/描画 */
function uuid(){ return Math.random().toString(36).slice(2,10); }
function fmtPct(v){ return (Math.round(v*10000)/10000) + "%"; }
function clampInt(v,min=1){ return Math.max(min, Math.floor(v||0)); }
function nowStr(){ return new Date().toLocaleString(); }
function escapeHtml(s){return (s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

$("#btn-add").addEventListener("click", ()=>{
  const r=$("#in-rarity").value.trim();
  const n=$("#in-name").value.trim();
  const p=+$("#in-prob").value;
  if(!n){ alert("商品名を入力してください"); return; }
  if(!(p>=0)){ alert("確率(%) を入力してください"); return; }
  const newItem={id:uuid(), rarity:r||"", name:n, prob:+p};
  state.items.push(newItem);
  renderList();
  const row = listEl.querySelector(`.tr[data-id="${newItem.id}"]`);
  if(row) row.classList.add("added");
});
$("#btn-clear").addEventListener("click", ()=>{ if(confirm("一覧をクリアしますか？")){ state.items=[]; renderList(); }});

function renderList(){
  listEl.innerHTML = "";
  const sum = state.items.reduce((a,b)=>a+(+b.prob||0),0);
  const over = sum>100.0000001;
  sumEl.textContent = `（合計: ${fmtPct(sum)}）`;
  warnEl.textContent = over ? "合計確率が100%を超えています。調整してください。" : "";
  warnEl.className = over ? "small warn" : "small";
  kpiTotal.textContent = fmtPct(sum);
  kpiMiss.textContent = fmtPct(Math.max(0,100-sum));
  kpiCount.textContent = state.items.length;

  state.items.forEach((it)=>{
    const row=document.createElement("div");
    row.className="tr"; row.draggable=true; row.dataset.id=it.id;

    const hwrap=document.createElement("div");
    hwrap.className="handle-wrap";
    const handle=document.createElement("div"); handle.className="handle"; handle.textContent="≡";
    const mrow=document.createElement("div"); mrow.className="move-row";
    const upBtn=document.createElement("button"); upBtn.className="btn-move-small"; upBtn.textContent="↑";
    const downBtn=document.createElement("button"); downBtn.className="btn-move-small"; downBtn.textContent="↓";
    upBtn.onclick=()=>moveItem(it.id,-1);
    downBtn.onclick=()=>moveItem(it.id,1);
    mrow.appendChild(upBtn); mrow.appendChild(downBtn);
    hwrap.appendChild(handle); hwrap.appendChild(mrow);
    row.appendChild(hwrap);

    const rarity=document.createElement("div");
    rarity.innerHTML=`<span class="rarity">${it.rarity||"-"}</span><div class="name-small">${escapeHtml(it.name)}</div>`;
    row.appendChild(rarity);

    const probView=document.createElement("div"); probView.innerHTML=`<span>${fmtPct(+it.prob||0)}</span>`; row.appendChild(probView);

    const editWrap=document.createElement("div");
    editWrap.innerHTML=`
      <label class="small" style="display:block;margin-bottom:3px;">確率%を変更</label>
      <input type="number" step="0.0001" value="${it.prob}" style="width:100%; box-sizing:border-box" />
    `;
    editWrap.querySelector("input").addEventListener("change",(e)=>{ it.prob=+e.target.value; renderList();});
    row.appendChild(editWrap);

    const del=document.createElement("div"); del.style.textAlign="right";
    const btn=document.createElement("button"); btn.className="btn btn-danger"; btn.textContent="削除";
    btn.addEventListener("click", ()=>{ state.items=state.items.filter(x=>x.id!==it.id); renderList(); });
    del.appendChild(btn); row.appendChild(del);

    listEl.appendChild(row);
  });
  enableReorder();
}
function moveItem(id,dir){
  const idx=state.items.findIndex(x=>x.id===id);
  if(idx<0)return;
  const ni=idx+dir;
  if(ni<0||ni>=state.items.length)return;
  const [a]=state.items.splice(idx,1);
  state.items.splice(ni,0,a);
  renderList();
  Array.from(listEl.children).forEach(el=>el.classList.add("reorder-anim"));
  setTimeout(()=>Array.from(listEl.children).forEach(el=>el.classList.remove("reorder-anim")),260);
}
function enableReorder(){
  let dragging=null;
  listEl.querySelectorAll(".tr").forEach(row=>{
    row.addEventListener("dragstart",()=>{ dragging=row; row.style.opacity=".6"; });
    row.addEventListener("dragend",()=>{ row.style.opacity="1"; });
    row.addEventListener("dragover",(e)=>{
      e.preventDefault(); if(!dragging || dragging===row) return;
      const rect=row.getBoundingClientRect();
      const before=(e.clientY-rect.top)<rect.height/2;
      listEl.insertBefore(dragging, before?row:row.nextSibling);
    });
  });
  listEl.addEventListener("drop", ()=>{
    const orderIds = Array.from(listEl.querySelectorAll(".tr")).map(el=>el.dataset.id);
    state.items.sort((a,b)=> orderIds.indexOf(a.id) - orderIds.indexOf(b.id));
    renderList();
    Array.from(listEl.children).forEach(el=>el.classList.add("reorder-anim"));
    setTimeout(()=>Array.from(listEl.children).forEach(el=>el.classList.remove("reorder-anim")),260);
  }, {once:true});
}

/* JSON I/O */
$("#btn-export").addEventListener("click", ()=>{
  const data = state.items.map(({rarity,name,prob})=>({rarity,name,prob}));
  $("#json-area").value = JSON.stringify(data, null, 2);
  showToast("設定を書き出しました");
});
$("#btn-import").addEventListener("click", ()=>{
  try{
    const arr = JSON.parse($("#json-area").value||"[]");
    if(!Array.isArray(arr)) throw 0;
    state.items = arr.map(o=>({id:uuid(), rarity:o.rarity||"", name:o.name||"", prob:+o.prob||0}));
    renderList();
    showToast("設定を読み込みました");
  }catch{ alert("JSONの形式が不正です"); }
});
$("#btn-json-copy").addEventListener("click", ()=>{
  navigator.clipboard.writeText($("#json-area").value||"");
  showToast("コピーしました");
});
$("#btn-json-paste").addEventListener("click", async ()=>{
  try{
    const txt = await navigator.clipboard.readText();
    $("#json-area").value = txt;
    showToast("ペーストしました");
  }catch{
    alert("クリップボードから読み込めませんでした");
  }
});

/* 抽選ロジック */
function calcPools(){
  const items=state.items.map(x=>({...x}));
  const sum=items.reduce((a,b)=>a+(+b.prob||0),0);
  if(sum>100.0000001){ alert("合計確率が100%を超えています。抽選できません。"); return null; }
  const miss=Math.max(0,100-sum);
  const pools=items.map(x=>({id:x.id,name:x.name,rarity:x.rarity,prob:+x.prob}));
  if(miss>0) pools.push({id:"miss",name:"ハズレ",rarity:"-",prob:miss});
  let acc=0; pools.forEach(p=>{acc+=p.prob;p._end=acc}); return {pools,total:acc};
}
function highlightResult(el){
  if(!el) return;
  el.classList.remove("pulse-glow"); void el.offsetWidth; el.classList.add("pulse-glow");
}

function drawN(n){
  const info=calcPools(); if(!info) return;
  playSE("sfx-draw");
  const {pools,total}=info;
  const counts={}; state.items.forEach(it=>counts[it.id]=0); if(pools.find(p=>p.id==="miss")) counts.miss=0;
  const chunkSize=100000;
  const doChunk=(left)=>{
    const m=Math.min(left,chunkSize);
    for(let i=0;i<m;i++){
      const r=Math.random()*total;
      const hit=pools.find(p=>r<p._end);
      counts[hit.id]=(counts[hit.id]||0)+1;
    }
    const remain=left-m;
    if(remain>0){ setTimeout(()=>doChunk(remain),0); }
    else{
      if(state.mode==="normal"){
        for(const k in counts){ state.totals[k]=(state.totals[k]||0)+counts[k]; }
        renderResult(counts,$("#result"));
        renderResult(state.totals,$("#total"));
        appendLog(n,counts);
        state.history.push({n,counts});
        state.lastSession = {n,counts};
        highlightResult($("#result"));
      }else{
        const p = getSelectedParticipant();
        if(!p){ alert("参加者を選択してください"); return; }
        for(const k in counts){ p.totals[k]=(p.totals[k]||0)+counts[k]; }
        for(const k in counts){ state.overallParticipantTotals[k]=(state.overallParticipantTotals[k]||0)+counts[k]; }
        renderResult(counts,$("#p-result"));
        renderResult(p.totals,$("#p-total"));
        appendParticipantLog(p,n,counts);
        p.history.push({n,counts});
        p.lastResult = {n,counts};
        renderParticipantOverall();
        highlightResult($("#p-result"));
      }
    }
  };
  doChunk(n);
}
function renderResult(map, el){
  const rows=[];
  state.items.forEach(it=>{
    const c=map[it.id]||0;
    if(c>0) rows.push(`<span class="pill">${it.rarity||"-"}｜${escapeHtml(it.name)} × <b>${c}</b></span>`);
  });
  if(map.miss>0) rows.push(`<span class="pill">ハズレ × <b>${map.miss}</b></span>`);
  el.innerHTML = rows.length? rows.join(" "):`<span class="small">（結果なし）</span>`;
}
function appendLog(n,session){
  const parts=[];
  state.items.forEach(it=>{ const c=session[it.id]||0; if(c>0) parts.push(`${it.name}×${c}`); });
  if(session.miss>0) parts.push(`ハズレ×${session.miss}`);
  $("#log").insertAdjacentHTML("afterbegin", `<div class="small">[${nowStr()}] ${n}回：${parts.join(" / ")||"（なし）"}</div>`);
}

/* 抽選UI 通常 */
$("#btn-once").addEventListener("click", ()=> drawN(1));
$("#btn-batch").addEventListener("click", ()=>{
  const n=clampInt(+$("#in-times").value,1); $("#in-times").value=n; drawN(n);
});
document.querySelectorAll(".step-btn").forEach(b=>{
  if(b.dataset.step){
    b.addEventListener("click", ()=>{
      const step = b.dataset.step;
      if(step==="reset"){
        $("#in-times").value = 0;
        return;
      }
      const num=parseInt(step,10);
      const v=clampInt((+$("#in-times").value||0)+num,1);
      $("#in-times").value=v;
    });
  }
});
$("#btn-total-reset").addEventListener("click", ()=>{
  if(confirm("累計結果をリセットしますか？")){
    state.totals={}; $("#total").innerHTML=""; showToast("累計をリセットしました");
  }
});

/* コピー(通常) */
function buildCopyString(n,counts){
  const parts=[];
  state.items.forEach(it=>{
    const c=counts[it.id]||0;
    if(c>0) parts.push(`[${it.rarity||"-"}]${it.name}×${c}`);
  });
  if(counts.miss>0) parts.push(`ハズレ×${counts.miss}`);
  return `${n}連：` + parts.join(" / ");
}
$("#btn-copy-current").addEventListener("click", ()=>{
  const s = state.lastSession;
  if(!s){ showToast("コピーする結果がありません"); return; }
  const txt = buildCopyString(s.n, s.counts);
  navigator.clipboard.writeText(txt);
  showToast("コピーしました");
});
$("#btn-copy-total").addEventListener("click", ()=>{
  const map = state.totals;
  const parts=[];
  state.items.forEach(it=>{
    const c=map[it.id]||0;
    if(c>0) parts.push(`[${it.rarity||"-"}]${it.name}×${c}`);
  });
  if(map.miss>0) parts.push(`ハズレ×${map.miss}`);
  const txt = `累計：` + (parts.join(" / ")||"なし");
  navigator.clipboard.writeText(txt);
  showToast("コピーしました");
});

/* 戻す */
$("#btn-undo-global").addEventListener("click", ()=>{
  const btn = $("#btn-undo-global");
  btn.classList.remove("reset-anim");
  void btn.offsetWidth;
  btn.classList.add("reset-anim");
  btn.classList.remove("warp"); void btn.offsetWidth; btn.classList.add("warp");

  if(!confirm("ガチャをキャンセルして前回の結果に戻しますか？")) return;
  if(state.mode==="normal"){
    const last = state.history.pop();
    if(!last){ showToast("戻す対象がありません"); return; }
    const {counts} = last;
    for(const k in counts){
      state.totals[k] = Math.max(0, (state.totals[k]||0) - counts[k]);
    }
    renderResult(state.totals,$("#total"));
    state.lastSession = null;
    showToast("直前の抽選を戻しました");
  }else{
    const p = getSelectedParticipant();
    if(!p){ showToast("参加者が選択されていません"); return; }
    const last = p.history.pop();
    if(!last){ showToast("戻す対象がありません"); return; }
    const {counts} = last;
    for(const k in counts){
      p.totals[k] = Math.max(0, (p.totals[k]||0) - counts[k]);
    }
    for(const k in counts){
      state.overallParticipantTotals[k] = Math.max(0, (state.overallParticipantTotals[k]||0) - counts[k]);
    }
    renderResult(p.totals,$("#p-total"));
    renderParticipantOverall();
    p.lastResult = null;
    showToast("直前の抽選を戻しました");
  }
});

/* 参加者モード */
function addParticipant(name){
  if(state.participants.length>=50){
    alert("参加者は最大50人までです。");
    return;
  }
  const id=uuid();
  state.participants.push({id,name,totals:{},history:[],logs:[],lastResult:null});
  state.selectedParticipantId=id;
  renderParticipantTabs();
  renderParticipantView();
  renderParticipantOverall();
}
function getSelectedParticipant(){
  return state.participants.find(p=>p.id===state.selectedParticipantId) || null;
}
function renderParticipantTabs(){
  const bar=$("#p-tab-bar");
  bar.innerHTML="";
  state.participants.forEach(p=>{
    const b=document.createElement("div");
    b.className="p-tab" + (p.id===state.selectedParticipantId?" active":"");
    b.textContent=p.name;
    b.addEventListener("click", ()=>{
      state.selectedParticipantId=p.id;
      renderParticipantTabs();
      renderParticipantView();
      b.classList.add("switching");
      setTimeout(()=>b.classList.remove("switching"),250);
    });
    bar.appendChild(b);
  });
}
function renderParticipantView(){
  const p=getSelectedParticipant();
  if(!p){
    $("#p-result").innerHTML=`<span class="small">参加者を追加してください</span>`;
    $("#p-total").innerHTML=``;
    $("#p-log").innerHTML=``;
    return;
  }
  if(p.lastResult){
    renderResult(p.lastResult.counts, $("#p-result"));
  }else{
    $("#p-result").innerHTML=`<span class="small">（まだ結果なし）</span>`;
  }
  renderResult(p.totals||{}, $("#p-total"));
  const logEl=$("#p-log"); logEl.innerHTML="";
  (p.logs||[]).forEach(html=>logEl.insertAdjacentHTML("beforeend", html));
}
function appendParticipantLog(p,n,session){
  const parts=[];
  state.items.forEach(it=>{ const c=session[it.id]||0; if(c>0) parts.push(`${it.name}×${c}`); });
  if(session.miss>0) parts.push(`ハズレ×${session.miss}`);
  const line = `<div class="small">[${nowStr()}] ${n}回：${parts.join(" / ")||"（なし）"}</div>`;
  p.logs = p.logs || [];
  p.logs.unshift(line);
  $("#p-log").insertAdjacentHTML("afterbegin", line);
}
function renderParticipantOverall(){
  const el=$("#p-overall");
  const map=state.overallParticipantTotals||{};
  const rows=[];
  state.items.forEach(it=>{
    const c=map[it.id]||0;
    if(c>0) rows.push(`<span class="pill">${it.rarity||"-"}｜${escapeHtml(it.name)} × <b>${c}</b></span>`);
  });
  if(map.miss>0) rows.push(`<span class="pill">ハズレ × <b>${map.miss}</b></span>`);
  el.innerHTML = `<div class="subcard" style="background:#0b1231; margin-top:4px;">
    <h4 style="margin:0 0 6px 0;">全体累計</h4>
    ${rows.length? rows.join(" "):`<span class="small">（まだありません）</span>`}
  </div>`;
}

/* 参加者追加 */
$("#p-new-add").addEventListener("click", ()=>{
  const name=$("#p-new-name").value.trim();
  if(!name) return;
  addParticipant(name);
  $("#p-new-name").value="";
});

/* 参加者抽選 */
$("#p-btn-once").addEventListener("click", ()=> drawN(1));
$("#p-btn-batch").addEventListener("click", ()=>{
  const n=clampInt(+$("#p-in-times").value,1); $("#p-in-times").value=n; drawN(n);
});
document.querySelectorAll("[data-pstep]").forEach(b=>{
  b.addEventListener("click", ()=>{
    const step=b.dataset.pstep;
    if(step==="reset"){ $("#p-in-times").value=0; return; }
    const num=parseInt(step,10);
    const v=clampInt((+$("#p-in-times").value||0)+num,1);
    $("#p-in-times").value=v;
  });
});

/* 参加者コピー */
$("#p-btn-copy-current").addEventListener("click", ()=>{
  const p = getSelectedParticipant();
  if(!p || !p.lastResult){ showToast("コピーする結果がありません"); return; }
  const {n,counts} = p.lastResult;
  const parts=[];
  state.items.forEach(it=>{
    const c=counts[it.id]||0;
    if(c>0) parts.push(`[${it.rarity||"-"}]${it.name}×${c}`);
  });
  if(counts.miss>0) parts.push(`ハズレ×${counts.miss}`);
  const txt = `${p.name}、${n}連：` + parts.join(" / ");
  navigator.clipboard.writeText(txt);
  showToast("コピーしました");
});
$("#p-btn-copy-total").addEventListener("click", ()=>{
  const p = getSelectedParticipant();
  if(!p){ showToast("コピーする結果がありません"); return; }
  const map = p.totals || {};
  const parts=[];
  state.items.forEach(it=>{
    const c=map[it.id]||0;
    if(c>0) parts.push(`[${it.rarity||"-"}]${it.name}×${c}`);
  });
  if(map.miss>0) parts.push(`ハズレ×${map.miss}`);
  const txt = `${p.name}、累計：` + (parts.join(" / ")||"なし");
  navigator.clipboard.writeText(txt);
  showToast("コピーしました");
});

/* 参加者削除 */
$("#p-btn-delete").addEventListener("click", ()=>{
  const p=getSelectedParticipant();
  if(!p) return;
  if(!confirm(`「${p.name}」を削除しますか？`)) return;
  state.participants = state.participants.filter(x=>x.id!==p.id);
  state.selectedParticipantId = state.participants[0]?.id || null;
  renderParticipantTabs();
  renderParticipantView();
  renderParticipantOverall();
  showToast("参加者を削除しました");
});

/* プロファイル */
function loadProfiles(){ try{ return JSON.parse(localStorage.getItem(state.profileKey)||"{}"); }catch{ return {}; } }
function saveProfiles(o){ localStorage.setItem(state.profileKey, JSON.stringify(o)); }
function refreshProfileList(){
  const obj=loadProfiles(), sel=$("#profile-list"); sel.innerHTML="";
  Object.keys(obj).forEach(name=>{ const opt=document.createElement("option"); opt.value=name; opt.textContent=name; sel.appendChild(opt); });
}
$("#btn-profile-save").addEventListener("click", ()=>{
  const name=$("#profile-name").value.trim(); if(!name){ alert("プロファイル名を入力してください"); return; }
  const obj=loadProfiles(); obj[name]=state.items.map(({rarity,name:nn,prob})=>({rarity,name:nn,prob:+prob})); saveProfiles(obj);
  refreshProfileList(); showToast("保存しました");
});
$("#btn-profile-load").addEventListener("click", ()=>{
  const name=$("#profile-list").value; if(!name){ alert("保存済みプロファイルがありません"); return; }
  const obj=loadProfiles(), data=obj[name]||[];
  state.items=data.map(o=>({id:uuid(), rarity:o.rarity||"", name:o.name||"", prob:+o.prob||0}));
  renderList(); $("#profile-name").value=name; showToast("読み込みました");
});
$("#btn-profile-rename").addEventListener("click", ()=>{
  const old=$("#profile-list").value; if(!old){ alert("対象を選択してください"); return; }
  const name=prompt("新しい名前", old); if(!name || name===old) return;
  const obj=loadProfiles(); obj[name]=obj[old]; delete obj[old]; saveProfiles(obj); refreshProfileList(); $("#profile-name").value=name; showToast("名前を変更しました");
});
$("#btn-profile-delete").addEventListener("click", ()=>{
  const name=$("#profile-list").value; if(!name) return;
  if(!confirm(`「${name}」を削除しますか？`)) return;
  const obj=loadProfiles(); delete obj[name]; saveProfiles(obj); refreshProfileList(); showToast("削除しました");
});

/* 星 */
(function starfield(){
  const c=$("#starfield"), ctx=c.getContext("2d",{alpha:true});
  function resize(){ c.width=innerWidth; c.height=innerHeight; }
  resize(); addEventListener("resize", resize);
  const STAR_MAX = Math.min(140, Math.floor((innerWidth*innerHeight)/18000));
  const stars = Array.from({length:STAR_MAX}).map(()=>({
    x:Math.random()*c.width, y:Math.random()*c.height, r:Math.random()*1.6+0.4,
    s:Math.random()*0.6+0.2, a:Math.random()*0.4+0.2
  }));
  function tick(){
    ctx.clearRect(0,0,c.width,c.height);
    for(const st of stars){
      st.x += st.s; st.y -= st.s*0.15;
      if(st.x>c.width+10) st.x=-10;
      if(st.y<-10) st.y=c.height+10;
      ctx.globalAlpha = st.a;
      ctx.beginPath(); ctx.arc(st.x,st.y,st.r,0,Math.PI*2);
      ctx.fillStyle = "#8bd5ff"; ctx.fill();
    }
    requestAnimationFrame(tick);
  }
  tick();
})();

/* 初期化 */
renderList(); refreshProfileList();
</script>
</body>
</html>
